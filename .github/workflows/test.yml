name: Mikrotik RouterOS Auto Download

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Get latest RouterOS 7 version
        run: |
          RAW=$(curl -s https://upgrade.mikrotik.com/routeros/LATEST.7)
          VERSION=$(echo "$RAW" | awk '{print $1}')   # ناخد أول كلمة فقط
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Latest version is $VERSION"

      - name: Download Netinstall
        run: |
          URL="https://download.mikrotik.com/routeros/${VERSION}/netinstall-${VERSION}.zip"
          echo "Downloading: $URL"
          wget -nv -O netinstall-${VERSION}.zip "$URL"

      - name: Download ISO
        run: |
          URL="https://download.mikrotik.com/routeros/${VERSION}/mikrotik-${VERSION}.iso"
          echo "Downloading: $URL"
          wget -nv -O mikrotik-${VERSION}.iso "$URL"

      - name: Download Install-Image
        run: |
          URL="https://download.mikrotik.com/routeros/${VERSION}/install-image-${VERSION}.zip"
          echo "Downloading: $URL"
          wget -nv -O install-image-${VERSION}.zip "$URL"

      - name: Download MMIPS
        run: |
          URL="https://download.mikrotik.com/routeros/${VERSION}/routeros-${VERSION}-mmips.npk"
          echo "Downloading: $URL"
          wget -nv -O routeros-${VERSION}-mmips.npk "$URL"

      - name: Download TILE
        run: |
          URL="https://download.mikrotik.com/routeros/${VERSION}/routeros-${VERSION}-tile.npk"
          echo "Downloading: $URL"
          wget -nv -O routeros-${VERSION}-tile.npk "$URL"

      - name: Download CHR
        run: |
          URL="https://download.mikrotik.com/routeros/${VERSION}/chr-${VERSION}.img.zip"
          echo "Downloading: $URL"
          wget -nv -O chr-${VERSION}.img.zip "$URL"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mikrotik-files
          path: |
            netinstall-*.zip
            mikrotik-*.iso
            install-image-*.zip
            routeros-*-mmips.npk
            routeros-*-tile.npk
            chr-*.img.zip
          retention-days: 3

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "MikroTik ${{ env.VERSION }}"
          tag_name: ${{ env.VERSION }}
          body: "Auto-downloaded MikroTik RouterOS version ${{ env.VERSION }}"
          files: |
            netinstall-${{ env.VERSION }}.zip
            mikrotik-${{ env.VERSION }}.iso
            install-image-${{ env.VERSION }}.zip
            routeros-${{ env.VERSION }}-mmips.npk
            routeros-${{ env.VERSION }}-tile.npk
            chr-${{ env.VERSION }}.img.zip
